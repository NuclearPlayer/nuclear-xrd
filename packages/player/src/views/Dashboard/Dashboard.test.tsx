import { DashboardProviderBuilder } from '../../test/builders/DashboardProviderBuilder';
import { TOP_TRACKS_RADIOHEAD } from '../../test/fixtures/dashboard';
import { DashboardWrapper } from './Dashboard.test-wrapper';

describe('Dashboard view', () => {
  beforeEach(() => {
    DashboardWrapper.reset();
  });

  it('shows empty state when no providers are registered', async () => {
    await DashboardWrapper.mount();

    expect(DashboardWrapper.emptyState).toBeInTheDocument();
    expect(DashboardWrapper.topTracks.table).not.toBeInTheDocument();
  });

  it('renders tracks in a table when a provider supplies top tracks', async () => {
    DashboardWrapper.seedProvider(
      DashboardWrapper.fixtures.topTracksProvider(),
    );

    await DashboardWrapper.mount();

    expect(DashboardWrapper.emptyState).not.toBeInTheDocument();
    expect(DashboardWrapper.topTracks.heading).toBeInTheDocument();
    expect(
      await DashboardWrapper.topTracks.findTrack(
        'Everything In Its Right Place',
      ),
    ).toBeInTheDocument();
    expect(
      await DashboardWrapper.topTracks.findTrack('Idioteque'),
    ).toBeInTheDocument();
  });

  it('renders both tracks and artists when provider has both capabilities', async () => {
    DashboardWrapper.seedProvider(
      DashboardWrapper.fixtures.topTracksAndArtistsProvider(),
    );

    await DashboardWrapper.mount();

    expect(DashboardWrapper.topTracks.heading).toBeInTheDocument();
    expect(
      await DashboardWrapper.topTracks.findTrack(
        'Everything In Its Right Place',
      ),
    ).toBeInTheDocument();

    expect(DashboardWrapper.topArtists.heading).toBeInTheDocument();
    expect(
      await DashboardWrapper.topArtists.artist('Radiohead').find(),
    ).toBeInTheDocument();
    expect(
      await DashboardWrapper.topArtists.artist('BjÃ¶rk').find(),
    ).toBeInTheDocument();
  });

  it('renders album cards when a provider supplies top albums', async () => {
    DashboardWrapper.seedProvider(
      DashboardWrapper.fixtures.topAlbumsProvider(),
    );

    await DashboardWrapper.mount();

    expect(
      await DashboardWrapper.topAlbums.album('Kid A').find(),
    ).toBeInTheDocument();
    expect(DashboardWrapper.topAlbums.heading).toBeInTheDocument();
  });

  it('renders playlist cards when a provider supplies editorial playlists', async () => {
    DashboardWrapper.seedProvider(
      DashboardWrapper.fixtures.editorialPlaylistsProvider(),
    );

    await DashboardWrapper.mount();

    expect(
      await DashboardWrapper.editorialPlaylists
        .playlist('Art Rock Essentials')
        .find(),
    ).toBeInTheDocument();
    expect(DashboardWrapper.editorialPlaylists.heading).toBeInTheDocument();
  });

  it('renders release cards when a provider supplies new releases', async () => {
    DashboardWrapper.seedProvider(
      DashboardWrapper.fixtures.newReleasesProvider(),
    );

    await DashboardWrapper.mount();

    expect(
      await DashboardWrapper.newReleases.release('In Rainbows').find(),
    ).toBeInTheDocument();
    expect(DashboardWrapper.newReleases.heading).toBeInTheDocument();
  });

  it('navigates to search when clicking an artist card without metadataProviderId', async () => {
    DashboardWrapper.seedProvider(
      DashboardWrapper.fixtures.topArtistsProviderWithoutMetadata(),
    );

    const { router } = await DashboardWrapper.mount();

    await DashboardWrapper.topArtists.artist('Radiohead').click();

    expect(router.state.location.pathname).toBe('/search');
    expect(router.state.location.search).toEqual({ q: 'Radiohead' });
  });

  it('shows tracks from multiple providers', async () => {
    DashboardWrapper.seedProvider(
      new DashboardProviderBuilder()
        .withId('provider-a')
        .withName('Soundwave')
        .withCapabilities('topTracks')
        .withFetchTopTracks(async () => [TOP_TRACKS_RADIOHEAD[0]]),
    );
    DashboardWrapper.seedProvider(
      new DashboardProviderBuilder()
        .withId('provider-b')
        .withName('Wavelength')
        .withCapabilities('topTracks')
        .withFetchTopTracks(async () => [TOP_TRACKS_RADIOHEAD[1]]),
    );

    await DashboardWrapper.mount();

    expect(
      await DashboardWrapper.topTracks.findTrack(
        'Everything In Its Right Place',
      ),
    ).toBeInTheDocument();
    expect(
      await DashboardWrapper.topTracks.findTrack('Idioteque'),
    ).toBeInTheDocument();
  });
});
